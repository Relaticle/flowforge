---
title: Upgrading to v3
description: Migration guide from Flowforge v2.x to v3.x
navigation:
  icon: i-lucide-arrow-up-circle
---

## Overview

Flowforge v3.x introduces a completely rewritten position management system. This guide covers the breaking changes and migration steps.

::callout{type="warning"}
**Breaking Changes:** v3.x is not backwards compatible with v2.x. Position data must be migrated.
::

## Requirements Changes

| Requirement | v2.x | v3.x |
|-------------|------|------|
| PHP | 8.2+ | 8.3+ |
| Laravel | 10+ | 11+ |
| Filament | 4.x | 4.x |
| PHP Extension | None | **ext-bcmath** |

### Install BCMath Extension

```bash
# Ubuntu/Debian
sudo apt-get install php-bcmath

# macOS (usually included)
php -m | grep bcmath

# Verify installation
php -r "echo bcadd('1.5', '2.5');"  # Should output: 4
```

## Breaking Changes

### 1. Position Column Type

The position column changed from `VARCHAR` to `DECIMAL(20,10)`.

**v2.x:** String-based fractional ranking with database-specific collations
```php
// v2.x created VARCHAR with collation
$table->string('position')->nullable()->collation('utf8mb4_bin');
```

**v3.x:** Decimal-based positioning with BCMath precision
```php
// v3.x creates DECIMAL
$table->decimal('position', 20, 10)->nullable();
```

### 2. Position Service Renamed

The `Rank` service has been replaced with `DecimalPosition`.

**v2.x:**
```php
use Relaticle\Flowforge\Services\Rank;

$position = Rank::forEmptySequence()->get();
$position = Rank::after($lastRank)->get();
$position = Rank::before($firstRank)->get();
$position = Rank::betweenRanks($before, $after)->get();
```

**v3.x:**
```php
use Relaticle\Flowforge\Services\DecimalPosition;

$position = DecimalPosition::forEmptyColumn();
$position = DecimalPosition::after($lastPosition);
$position = DecimalPosition::before($firstPosition);
$position = DecimalPosition::between($before, $after);
```

### 3. Method Naming Changes

| v2.x Method | v3.x Method |
|-------------|-------------|
| `Rank::forEmptySequence()->get()` | `DecimalPosition::forEmptyColumn()` |
| `Rank::after($rank)->get()` | `DecimalPosition::after($position)` |
| `Rank::before($rank)->get()` | `DecimalPosition::before($position)` |
| `Rank::betweenRanks($a, $b)->get()` | `DecimalPosition::between($a, $b)` |

::callout{type="info"}
v3.x methods return strings directly - no `.get()` call needed.
::

## Migration Steps

### Step 1: Update Dependencies

```bash
composer require relaticle/flowforge:^3.0
```

### Step 2: Create Migration

Create a migration to convert the position column:

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;
use Relaticle\Flowforge\Services\DecimalPosition;

return new class extends Migration
{
    public function up(): void
    {
        // 1. Add new decimal column
        Schema::table('tasks', function (Blueprint $table) {
            $table->decimal('position_new', 20, 10)->nullable()->after('position');
        });

        // 2. Convert existing positions maintaining order
        $columnField = 'status'; // Your column identifier field

        $columns = DB::table('tasks')->distinct()->pluck($columnField);

        foreach ($columns as $column) {
            $records = DB::table('tasks')
                ->where($columnField, $column)
                ->orderBy('position')
                ->get();

            $lastPosition = null;
            foreach ($records as $record) {
                $newPosition = $lastPosition === null
                    ? DecimalPosition::forEmptyColumn()
                    : DecimalPosition::after($lastPosition);

                DB::table('tasks')
                    ->where('id', $record->id)
                    ->update(['position_new' => $newPosition]);

                $lastPosition = $newPosition;
            }
        }

        // 3. Swap columns
        Schema::table('tasks', function (Blueprint $table) {
            $table->dropColumn('position');
        });

        Schema::table('tasks', function (Blueprint $table) {
            $table->renameColumn('position_new', 'position');
        });

        // 4. Add unique constraint (recommended)
        Schema::table('tasks', function (Blueprint $table) {
            $table->unique(['status', 'position'], 'unique_position_per_column');
        });
    }

    public function down(): void
    {
        Schema::table('tasks', function (Blueprint $table) {
            $table->dropUnique('unique_position_per_column');
            $table->dropColumn('position');
        });

        Schema::table('tasks', function (Blueprint $table) {
            $table->string('position')->nullable();
        });
    }
};
```

### Step 3: Update Factory Code

If you have factories generating position values:

**Before (v2.x):**
```php
use Relaticle\Flowforge\Services\Rank;

private function generatePosition(string $status): string
{
    if (!isset(self::$lastRanks[$status])) {
        $rank = Rank::forEmptySequence();
    } else {
        $rank = Rank::after(self::$lastRanks[$status]);
    }

    self::$lastRanks[$status] = $rank;
    return $rank->get();
}
```

**After (v3.x):**
```php
use Relaticle\Flowforge\Services\DecimalPosition;

private function generatePosition(string $status): string
{
    if (!isset(self::$lastPositions[$status])) {
        $position = DecimalPosition::forEmptyColumn();
    } else {
        $position = DecimalPosition::after(self::$lastPositions[$status]);
    }

    self::$lastPositions[$status] = $position;
    return $position;
}
```

### Step 4: Run Migration

```bash
php artisan migrate
```

### Step 5: Verify

Use the new diagnostic command to verify positions:

```bash
php artisan flowforge:diagnose-positions \
    --model=App\\Models\\Task \
    --column=status \
    --position=position
```

## New Features in v3.x

### Concurrent Safety

v3.x adds automatic jitter to position calculations, preventing collisions when multiple users drag cards simultaneously.

### Auto-Rebalancing

When gaps between positions become too small (< 0.0001), positions are automatically redistributed.

### New Commands

```bash
# Diagnose position issues
php artisan flowforge:diagnose-positions

# Rebalance positions evenly
php artisan flowforge:rebalance-positions

# Interactive repair
php artisan flowforge:repair-positions
```

### Retry Mechanism

Position updates now include automatic retry logic with exponential backoff for handling rare unique constraint violations.

## Fresh Install Alternative

If you don't need to preserve card order, you can do a clean migration:

```php
public function up(): void
{
    Schema::table('tasks', function (Blueprint $table) {
        $table->dropColumn('position');
    });

    Schema::table('tasks', function (Blueprint $table) {
        $table->flowforgePositionColumn();
        $table->unique(['status', 'position'], 'unique_position_per_column');
    });
}
```

Then regenerate positions:

```bash
php artisan flowforge:repair-positions
```

## Need Help?

- [GitHub Issues](https://github.com/relaticle/flowforge/issues)
- [Discord Community](https://discord.gg/b9WxzUce4Q)
